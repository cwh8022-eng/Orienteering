<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ·¡æ±Ÿå¤§å­¸å®šå‘é‹å‹•é—–é—œæŒ‘æˆ°ï½œé¦–é </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¯é¸ï¼šIcon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24'%3E%3Cpath fill='%23f97316' d='M11 21q-.425 0-.713-.288T10 20v-2H8q-.825 0-1.413-.588T6 16v-3.175q-1.2-.35-2.1-1.3T3 9V7q0-.825.588-1.413T5 5h4.35q.3-.9 1.05-1.45T12 3q.9 0 1.65.55T14.7 5H19q.825 0 1.413.588T21 7v2q0 1.3-.9 2.25T18 12.825V16q0 .825-.588 1.413T16 18h-2v2q0 .425-.288.713T13 21zm1-15q.425 0 .713-.288T13 5t-.288-.712T12 4t-.712.288T11 5t.288.713T12 6'/%3E%3C/svg%3E"/>
  <!-- TM Imageï¼ˆå½±åƒåˆ†é¡ï¼‰-->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <style>
    /* åœ°åœ–å®¹å™¨è®“é»ä½ç”¨ç™¾åˆ†æ¯”å®šä½ï¼ˆéŸ¿æ‡‰å¼ï¼‰ */
    .map-wrap { position: relative; }
    .map-wrap img { width: 100%; height: auto; display:block; }
    .poi {
      position: absolute;
      transform: translate(-50%, -50%);
      width: 28px; height: 28px;
      border-radius: 9999px;
      background: #f97316;
      color:#fff; font-weight:700;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 16px rgba(249,115,22,.35);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .poi:hover { transform: translate(-50%, -50%) scale(1.06); }
    .poi.done { background:#22c55e; box-shadow: 0 6px 16px rgba(34,197,94,.35); }
    /* å¾½ç« æ–¹å¡Š */
    .badge { border:1px dashed #e5e7eb; border-radius: .75rem; padding:.6rem; text-align:center; font-size:.85rem }
    .badge.done{ border-style:solid; background:#f0fdf4; }
    /* Modal */
    .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal-card { width:min(560px,92vw); background:#fff; border-radius:1rem; padding:1rem; box-shadow:0 20px 60px rgba(0,0,0,.25) }
  </style>
</head>
<body class="bg-orange-50/40 text-slate-800">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 py-6 flex items-center gap-4">
    <div class="w-12 h-12 rounded-2xl bg-orange-500 text-white grid place-items-center font-extrabold">TKU</div>
    <div>
      <h1 class="text-2xl md:text-3xl font-extrabold">æ·¡æ±Ÿå¤§å­¸å®šå‘é‹å‹•é—–é—œæŒ‘æˆ°</h1>
      <p class="text-slate-600">æ‰¾åˆ°æ ¡åœ’ 25 å€‹ç§˜å¯†æ¨™çš„ç‰©ï¼Œæ‹ç…§ä¸Šå‚³è®“ AI è¾¨è­˜ï¼Œè’é›†å…¨éƒ¨å¾½ç« ï¼</p>
    </div>
    <div class="ms-auto">
      <button id="howBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">è¦å‰‡èªªæ˜</button>
    </div>
  </header>

  <!-- é€²åº¦ / å‹•ä½œåˆ— -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="grid md:grid-cols-3 gap-4 items-stretch">
      <div class="col-span-2 bg-white rounded-2xl p-4 border border-slate-200">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-bold">æˆ‘çš„é—–é—œé€²åº¦</h2>
          <button id="resetBtn" class="text-sm text-slate-500 hover:text-red-600" title="æ¸…é™¤æœ¬æ©Ÿé€²åº¦">æ¸…é™¤é€²åº¦</button>
        </div>
        <div class="w-full bg-slate-100 rounded-xl h-3">
          <div id="progressBar" class="bg-orange-500 h-3 rounded-xl" style="width:0%"></div>
        </div>
        <p id="progressText" class="text-sm mt-2 text-slate-600">å·²å®Œæˆ 0 / 25</p>
      </div>

      <div class="bg-white rounded-2xl p-4 border border-slate-200">
        <h2 class="font-bold mb-2">å¿«é€Ÿå‹•ä½œ</h2>
        <div class="flex flex-wrap gap-2">
          <button id="startBtn" class="px-3 py-2 rounded-xl bg-orange-500 text-white hover:bg-orange-600">é–‹å§‹æŒ‘æˆ°</button>
          <button id="badgesBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">æˆ‘çš„å¾½ç« </button>
        </div>
        <p class="text-xs text-slate-500 mt-3">æç¤ºï¼šé»æ“Šåœ°åœ–ä¸Šçš„æ©˜è‰²åœ“é»å³å¯ä¸Šå‚³ç…§ç‰‡é—–é—œã€‚</p>
      </div>
    </div>
  </section>

  <!-- åœ°åœ–å€ -->
  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div class="bg-white rounded-2xl p-3 border border-slate-200">
      <div class="flex items-center gap-3 mb-3">
        <h2 class="font-bold">æ ¡åœ’åœ°åœ–</h2>
        <span class="text-xs text-slate-500">ï¼ˆé»é¸ä»»ä¸€é—œå¡é»ä½é–‹å§‹ä¸Šå‚³èˆ‡è¾¨è­˜ï¼‰</span>
      </div>
      <div id="mapWrap" class="map-wrap">
        <!-- è«‹å°‡ä½ çš„åœ°åœ–åœ–æª”æ”¾åˆ° ./assets/tku_map.jpg æˆ–æ”¹ src -->
        <img id="campusMap" src="assets/tku_map.jpg" alt="Tamkang University Orienteering Map" />
        <!-- é»ä½æœƒç”± JS ä¾æ“šåº§æ¨™é™£åˆ—ç¹ªè£½ -->
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">
      â€» é»ä½åº§æ¨™æ¡ç™¾åˆ†æ¯”å®šä½ï¼Œè«‹ä¾å¯¦éš›éœ€è¦åˆ°ç¨‹å¼ä¸­çš„ <code>POINTS</code> é™£åˆ—å¾®èª¿ <code>x</code>/<code>y</code>ã€‚
    </p>
  </section>

  <!-- å¾½ç« ç‰† -->
  <section class="max-w-6xl mx-auto px-4 mt-6 mb-20">
    <div class="bg-white rounded-2xl p-4 border border-slate-200">
      <div class="flex items-center gap-3 mb-3">
        <h2 class="font-bold">å¾½ç« æ”¶é›†</h2>
        <span class="text-xs text-slate-500">è’é›† 25 æšå¾½ç« ï¼Œå³å®Œæˆæœ€çµ‚æŒ‘æˆ°ï¼</span>
      </div>
      <div id="badgeGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-3"></div>
    </div>
  </section>

  <!-- è¦å‰‡ Modal -->
  <div id="howModal" class="modal-mask">
    <div class="modal-card">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold text-lg">éŠæˆ²è¦å‰‡</h3>
        <button class="text-slate-500" onclick="toggleHow(false)">âœ•</button>
      </div>
      <ol class="list-decimal ps-5 space-y-1 text-slate-700">
        <li>åœ¨åœ°åœ–ä¸Šé»é¸ä»»ä¸€é—œå¡é»ã€‚</li>
        <li>å‰å¾€è©²é»ä½ï¼Œæ‹æ”è©²é»<strong>æŒ‡å®šæ¨™çš„ç‰©</strong>ï¼ˆæˆ–ä¸Šå‚³ä¹‹å‰æ‹çš„ç…§ç‰‡ï¼‰ã€‚</li>
        <li>ç³»çµ±æœƒä½¿ç”¨ AIï¼ˆTeachable Machineï¼‰è¾¨è­˜æ˜¯å¦ç¬¦åˆè©²é»ä½çš„æ¨™ç±¤ã€‚</li>
        <li>é€šéå¾Œå³å¯è§£é–è©²é»å¾½ç« ï¼Œé€²åº¦æœƒå„²å­˜åœ¨æœ¬æ©Ÿã€‚</li>
        <li>é›†æ»¿ 25 æšå¾½ç« å³å¯å®ŒæˆæŒ‘æˆ°ï¼</li>
      </ol>
      <div class="mt-3 text-sm text-slate-500">
        â€» ç®¡ç†è€…å¯åœ¨ç¨‹å¼å…§è¨­å®šï¼šæ¨¡å‹ç¶²å€ã€å„é»ä½å°æ‡‰æ¨™ç±¤ã€ä»¥åŠé»ä½åº§æ¨™ã€‚
      </div>
      <div class="mt-4 text-right">
        <button class="px-3 py-2 rounded-xl bg-orange-500 text-white" onclick="toggleHow(false)">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- ä¸Šå‚³ / è¾¨è­˜ Modal -->
  <div id="taskModal" class="modal-mask">
    <div class="modal-card">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 id="taskTitle" class="font-bold text-lg">é—œå¡</h3>
          <p id="taskSubtitle" class="text-sm text-slate-500">è«‹ä¸Šå‚³æŒ‡å®šæ¨™çš„ç‰©ç…§ç‰‡</p>
        </div>
        <button class="text-slate-500" onclick="toggleTask(false)">âœ•</button>
      </div>

      <div class="mt-3">
        <div class="rounded-xl border border-dashed border-slate-300 p-3">
          <input id="imageInput" type="file" accept="image/*;capture=camera" class="block w-full text-sm" />
          <p class="text-xs text-slate-500 mt-1">å¯ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæ‹ç…§æˆ–å¾ç›¸ç°¿é¸æ“‡ã€‚</p>
        </div>
        <div id="previewWrap" class="mt-3 hidden">
          <img id="previewImg" class="max-h-64 rounded-xl border border-slate-200" alt="é è¦½"/>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="checkBtn" class="px-3 py-2 rounded-xl bg-orange-500 text-white disabled:opacity-50" disabled>é–‹å§‹è¾¨è­˜</button>
          <button class="px-3 py-2 rounded-xl bg-white border border-slate-200" onclick="toggleTask(false)">ç¨å¾Œå†è©¦</button>
        </div>
        <div id="resultBox" class="mt-3 hidden">
          <div id="resultText" class="text-sm"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= ç®¡ç†è€…å¯èª¿æ•´å€ ========= */
// 1) ä½ çš„ Teachable Machine å½±åƒæ¨¡å‹ç¶²å€ï¼ˆåŒ¯å‡ºå¾Œçš„ model.json æ‰€åœ¨è³‡æ–™å¤¾ï¼‰
const MODEL_URL = ""; // ä¾‹å¦‚ "https://teachablemachine.withgoogle.com/models/XXXX/"
// 2) 25 å€‹é»ä½è¨­å®šï¼šåç¨± / å°æ‡‰ AI æ¨™ç±¤ï¼ˆclassNameï¼‰/ åº§æ¨™ï¼ˆ%ï¼‰
const POINTS = [
  // x, y ç‚ºç›¸å°åœ°åœ–åœ–ç‰‡çš„ç™¾åˆ†æ¯”åº§æ¨™ï¼ˆè«‹ä¾å¯¦éš›ä½ç½®å¾®èª¿ï¼‰
  {id:1,  name:"é—œå¡ 1",  label:"P1",  x:12,  y:82},
  {id:2,  name:"é—œå¡ 2",  label:"P2",  x:18,  y:78},
  {id:3,  name:"é—œå¡ 3",  label:"P3",  x:24,  y:74},
  {id:4,  name:"é—œå¡ 4",  label:"P4",  x:30,  y:70},
  {id:5,  name:"é—œå¡ 5",  label:"P5",  x:36,  y:66},
  {id:6,  name:"é—œå¡ 6",  label:"P6",  x:42,  y:62},
  {id:7,  name:"é—œå¡ 7",  label:"P7",  x:48,  y:58},
  {id:8,  name:"é—œå¡ 8",  label:"P8",  x:54,  y:54},
  {id:9,  name:"é—œå¡ 9",  label:"P9",  x:60,  y:50},
  {id:10, name:"é—œå¡ 10", label:"P10", x:66,  y:46},
  {id:11, name:"é—œå¡ 11", label:"P11", x:72,  y:42},
  {id:12, name:"é—œå¡ 12", label:"P12", x:78,  y:38},
  {id:13, name:"é—œå¡ 13", label:"P13", x:84,  y:34},
  {id:14, name:"é—œå¡ 14", label:"P14", x:20,  y:58},
  {id:15, name:"é—œå¡ 15", label:"P15", x:26,  y:52},
  {id:16, name:"é—œå¡ 16", label:"P16", x:32,  y:46},
  {id:17, name:"é—œå¡ 17", label:"P17", x:38,  y:40},
  {id:18, name:"é—œå¡ 18", label:"P18", x:44,  y:34},
  {id:19, name:"é—œå¡ 19", label:"P19", x:50,  y:28},
  {id:20, name:"é—œå¡ 20", label:"P20", x:56,  y:22},
  {id:21, name:"é—œå¡ 21", label:"P21", x:62,  y:30},
  {id:22, name:"é—œå¡ 22", label:"P22", x:68,  y:56},
  {id:23, name:"é—œå¡ 23", label:"P23", x:74,  y:60},
  {id:24, name:"é—œå¡ 24", label:"P24", x:80,  y:64},
  {id:25, name:"é—œå¡ 25", label:"P25", x:86,  y:68},
];
// 3) è¾¨è­˜é–€æª»ï¼šè‹¥æ¨¡å‹è¼¸å‡ºç›®æ¨™æ¨™ç±¤ä¹‹ä¿¡å¿ƒ >= threshold å³åˆ¤å®šé€šé
const THRESHOLD = 0.70;
/* ================================= */

let model, maxPredictions;
let currentPoint = null;
const STORAGE_KEY = "tku_orienteering_progress_v1";

// åˆå§‹åŒ–
document.addEventListener("DOMContentLoaded", () => {
  renderMapPoints();
  renderBadges();
  updateProgressUI();
  bindUI();
  if (MODEL_URL) initTM().catch(console.warn);
});

function bindUI(){
  document.getElementById("startBtn").addEventListener("click", () => {
    window.scrollTo({ top: document.getElementById("mapWrap").offsetTop - 16, behavior:"smooth" });
  });
  document.getElementById("badgesBtn").addEventListener("click", () => {
    window.scrollTo({ top: document.getElementById("badgeGrid").offsetTop - 16, behavior:"smooth" });
  });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if(confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿé—–é—œé€²åº¦ï¼Ÿ")) {
      localStorage.removeItem(STORAGE_KEY);
      renderMapPoints();
      renderBadges();
      updateProgressUI();
    }
  });
  document.getElementById("howBtn").addEventListener("click", () => toggleHow(true));
  document.getElementById("imageInput").addEventListener("change", handleFileChange);
  document.getElementById("checkBtn").addEventListener("click", runCheck);
}

function toggleHow(show){
  document.getElementById("howModal").style.display = show ? "flex" : "none";
}
function toggleTask(show){
  const mask = document.getElementById("taskModal");
  mask.style.display = show ? "flex" : "none";
  if(!show){
    document.getElementById("imageInput").value = "";
    document.getElementById("previewWrap").classList.add("hidden");
    document.getElementById("resultBox").classList.add("hidden");
    document.getElementById("checkBtn").disabled = true;
    currentPoint = null;
  }
}

// åœ°åœ–é»ä½æ¸²æŸ“
function renderMapPoints(){
  const wrap = document.getElementById("mapWrap");
  // å…ˆæ¸…æ‰èˆŠé»
  wrap.querySelectorAll(".poi").forEach(n=>n.remove());
  const doneSet = getProgressSet();

  POINTS.forEach(p=>{
    const dot = document.createElement("button");
    dot.className = "poi" + (doneSet.has(p.id) ? " done" : "");
    dot.style.left = p.x + "%";
    dot.style.top  = p.y + "%";
    dot.title = `${p.name}ï¼ˆæ¨™ç±¤ï¼š${p.label}ï¼‰`;
    dot.textContent = p.id;
    dot.addEventListener("click", ()=>openTask(p));
    wrap.appendChild(dot);
  });
}

// å¾½ç« ç‰†
function renderBadges(){
  const grid = document.getElementById("badgeGrid");
  grid.innerHTML = "";
  const doneSet = getProgressSet();

  POINTS.forEach(p=>{
    const card = document.createElement("div");
    card.className = "badge " + (doneSet.has(p.id) ? "done" : "");
    card.innerHTML = `
      <div class="text-xs text-slate-500">#${p.id}</div>
      <div class="font-bold mt-1">${p.name}</div>
      <div class="text-xs text-slate-500">æ¨™ç±¤ï¼š<code>${p.label}</code></div>
      <div class="mt-2">
        ${doneSet.has(p.id)
          ? '<span class="inline-flex items-center gap-1 text-green-600 text-sm">âœ… å·²ç²å¾—</span>'
          : '<span class="inline-flex items-center gap-1 text-slate-400 text-sm">ğŸ”’ æœªè§£é–</span>'}
      </div>`;
    grid.appendChild(card);
  });
}

// é€²åº¦
function getProgressSet(){
  try{
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    return new Set(arr);
  }catch(e){ return new Set(); }
}
function setProgressSet(set){
  const arr = Array.from(set);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}
function addProgress(id){
  const s = getProgressSet();
  s.add(id);
  setProgressSet(s);
  renderMapPoints();
  renderBadges();
  updateProgressUI();
}
function updateProgressUI(){
  const count = getProgressSet().size;
  const percent = Math.round((count / POINTS.length) * 100);
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressText").textContent = `å·²å®Œæˆ ${count} / ${POINTS.length}`;
}

// é–‹å•Ÿä»»å‹™
function openTask(p){
  currentPoint = p;
  document.getElementById("taskTitle").textContent = `${p.name}`;
  document.getElementById("taskSubtitle").innerHTML = `è«‹ä¸Šå‚³ã€Œ<b>${p.label}</b>ã€å°æ‡‰çš„æ¨™çš„ç‰©ç…§ç‰‡ï¼ˆAI éœ€è¾¨è­˜åˆ°æ­¤æ¨™ç±¤æ‰ç®—é€šéï¼‰`;
  toggleTask(true);
}

// é è¦½ & å•Ÿç”¨è¾¨è­˜
function handleFileChange(e){
  const file = e.target.files[0];
  if(!file){ return; }
  const url = URL.createObjectURL(file);
  document.getElementById("previewImg").src = url;
  document.getElementById("previewWrap").classList.remove("hidden");
  document.getElementById("resultBox").classList.add("hidden");
  document.getElementById("checkBtn").disabled = false;
}

// åˆå§‹åŒ– Teachable Machineï¼ˆè‹¥æœªè¨­å®š MODEL_URLï¼Œå‰‡ä»¥ã€Œç¤ºç¯„æ¨¡å¼ã€é‹ä½œï¼‰
async function initTM(){
  try{
    const modelURL = MODEL_URL.endsWith("/") ? MODEL_URL + "model.json" : MODEL_URL + "/model.json";
    const metadataURL = MODEL_URL.endsWith("/") ? MODEL_URL + "metadata.json" : MODEL_URL + "/metadata.json";
    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();
    console.log("TM æ¨¡å‹è¼‰å…¥å®Œæˆï¼Œclasses:", maxPredictions);
  }catch(err){
    console.warn("æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œå°‡ä½¿ç”¨ç¤ºç¯„æ¨¡å¼ï¼š", err);
    model = null;
  }
}

// åŸ·è¡Œè¾¨è­˜
async function runCheck(){
  const info = document.getElementById("resultText");
  const box  = document.getElementById("resultBox");
  box.classList.remove("hidden");
  info.textContent = "è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™â€¦";

  const imgEl = document.getElementById("previewImg");
  let pass = false, best = {className:"", probability:0};

  if(model){
    // ä»¥ TM Image é€²è¡Œåˆ†é¡
    const preds = await model.predict(imgEl, false);
    preds.sort((a,b)=>b.probability - a.probability);
    best = preds[0];
    const target = (currentPoint?.label || "").trim();
    const hit = preds.find(p => p.className === target);
    const score = hit ? hit.probability : 0;
    pass = score >= THRESHOLD;
  }else{
    // ç¤ºç¯„æ¨¡å¼ï¼šè‹¥æª”ååŒ…å« label å­—æ¨£å°±ç•¶ä½œé€šéï¼ˆæ–¹ä¾¿æ²’æ¨¡å‹æ™‚å…ˆ demoï¼‰
    const fileName = (document.getElementById("imageInput").files[0]?.name || "").toLowerCase();
    const token = (currentPoint?.label || "").toLowerCase();
    pass = token && fileName.includes(token);
    best = {className: pass ? currentPoint?.label : "Unknown", probability: pass ? 0.9 : 0.2};
  }

  if(pass){
    info.innerHTML = `âœ… <b>é—–é—œæˆåŠŸï¼</b> åµæ¸¬åˆ°æ¨™ç±¤ <code>${currentPoint.label}</code>ï¼ˆæœ€é«˜ï¼š${best.className}ï¼Œä¿¡å¿ƒ ${best.probability.toFixed(2)}ï¼‰`;
    addProgress(currentPoint.id);
  }else{
    info.innerHTML = `âŒ <b>å°šæœªé€šé</b>ï¼šæœªåµæ¸¬åˆ° <code>${currentPoint.label}</code>ï¼ˆæœ€é«˜ï¼š${best.className}ï¼Œä¿¡å¿ƒ ${best.probability.toFixed(2)}ï¼‰<br>
    å»ºè­°ï¼šæ›è§’åº¦å†æ‹ã€è®“æ¨™çš„ç‰©æ›´æ¸…æ¥šï¼Œæˆ–åœ¨å…‰ç·šå……è¶³è™•é‡æ‹ã€‚`;
  }
}

/* è¦å‰‡è¦–çª—é è¨­é–‹ä¸€æ¬¡ */
setTimeout(()=>toggleHow(true), 400);
</script>
</body>
</html>
