<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>淡江大學定向運動闖關挑戰（CORS 免擋版）</title>
<link rel="stylesheet" href="./styles.css" />
<style>
  :root { --accent:#f97316; --ok:#22c55e; }
  .pill{
    width:72px;height:72px;display:flex;align-items:center;justify-content:center;
    border-radius:0.9rem;background:var(--accent);color:#fff;font-weight:800;font-size:1.1rem
  }
  .pill.done{ background:var(--ok); }
  .badge { border:1px dashed #e5e7eb; border-radius:.75rem; padding:.6rem; text-align:center; font-size:.85rem }
  .badge.done{ border-style:solid; background:#f0fdf4; }
  .modal-mask{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal-card{ width:min(560px,92vw); background:#fff; border-radius:1rem; padding:1rem; box-shadow:0 20px 60px rgba(0,0,0,.25) }
  .muted{ color:#64748b;font-size:.85rem }
</style>
</head>
<body class="bg-orange-50/40 text-slate-800">
<header class="max-w-6xl mx-auto px-4 py-6 flex items-center gap-4">
  <div class="w-12 h-12 rounded-2xl bg-[var(--accent)] text-white grid place-items-center font-extrabold">TKU</div>
  <div>
    <h1 class="text-2xl md:text-3xl font-extrabold">淡江大學定向運動闖關挑戰</h1>
    <p class="text-slate-600">自拍 → 送到 Google Drive；被跨網域擋時自動用新分頁提交。</p>
  </div>
  <div class="ms-auto flex gap-2">
    <button id="howBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">規則說明</button>
    <button id="idBtn"  class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">設定學號</button>
  </div>
</header>

<section class="max-w-6xl mx-auto px-4">
  <div class="grid md:grid-cols-3 gap-4 items-stretch">
    <div class="col-span-2 bg-white rounded-2xl p-4 border border-slate-200">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold">我的闖關進度</h2>
        <button id="resetBtn" class="text-sm text-slate-500 hover:text-red-600">清除進度</button>
      </div>
      <div class="w-full bg-slate-100 rounded-xl h-3">
        <div id="progressBar" class="bg-[var(--accent)] h-3 rounded-xl" style="width:0%"></div>
      </div>
      <p id="progressText" class="text-sm mt-2 text-slate-600">已完成 0 / 25</p>
      <p class="text-xs mt-1 text-slate-500">學號：<span id="sidVal">（未設定）</span></p>
    </div>
    <div class="bg-white rounded-2xl p-4 border border-slate-200">
      <h2 class="font-bold mb-2">快速動作</h2>
      <div class="flex flex-wrap gap-2">
        <button id="startBtn" class="px-3 py-2 rounded-xl bg-[var(--accent)] text-white hover:opacity-90">開始挑戰</button>
        <button id="badgesBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">我的徽章</button>
      </div>
      <p class="muted mt-3">＊若彈出視窗被擋，請允許本頁開啟新分頁。</p>
    </div>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6">
  <div class="bg-white rounded-2xl p-3 border border-slate-200">
    <h2 class="font-bold mb-3">校園地圖（參考）</h2>
    <img src="assets/tku_map.jpg" class="w-full h-auto rounded-xl border border-slate-200"
         onerror="this.nextElementSibling.classList.remove('hidden')" alt="map"/>
    <div class="hidden mt-2 text-sm text-red-600">找不到地圖：<code>assets/tku_map.jpg</code></div>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6">
  <div class="bg-white rounded-2xl p-3 border border-slate-200">
    <h2 class="font-bold mb-3">拍照目標一覽（#1–#25）</h2>
    <img src="assets/tku_targets.jpg" class="w-full h-auto rounded-xl border border-slate-200"
         onerror="this.nextElementSibling.classList.remove('hidden')" alt="targets"/>
    <div class="hidden mt-2 text-sm text-red-600">找不到拼圖：<code>assets/tku_targets.jpg</code></div>
    <p class="text-xs text-slate-500 mt-2">只顯示編號，不提供中文提示。</p>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6">
  <div class="bg-white rounded-2xl p-4 border border-slate-200">
    <h2 class="font-bold mb-3">關卡列表（點擊編號上傳）</h2>
    <div id="poiList" class="grid grid-cols-5 gap-3"></div>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6 mb-20">
  <div class="bg-white rounded-2xl p-4 border border-slate-200">
    <div class="flex items-center gap-3 mb-3">
      <h2 class="font-bold">徽章收集</h2>
      <span class="text-xs text-slate-500">蒐集 25 枚徽章，即完成最終挑戰！</span>
    </div>
    <div id="badgeGrid" class="grid grid-cols-5 sm:grid-cols-6 lg:grid-cols-8 gap-3"></div>
  </div>
</section>

<!-- 規則 Modal -->
<div id="howModal" class="modal-mask">
  <div class="modal-card">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-bold text-lg">遊戲規則（目前為上傳測試模式）</h3>
      <button class="text-slate-500" onclick="toggleHow(false)">✕</button>
    </div>
    <ol class="list-decimal ps-5 space-y-1 text-slate-700">
      <li>在關卡列表點選編號（#1~#25）。</li>
      <li>自拍並拍下該編號的標的物。</li>
      <li>按「上傳到 Google Drive」後，會在新分頁顯示結果（Drive 連結 + 內建預覽）。</li>
      <li>進度儲存在本機；集滿 25 枚徽章完成挑戰。</li>
    </ol>
    <div class="mt-4 text-right"><button class="px-3 py-2 rounded-xl bg-[var(--accent)] text-white" onclick="toggleHow(false)">我知道了</button></div>
  </div>
</div>

<!-- 上傳 Modal -->
<div id="taskModal" class="modal-mask">
  <div class="modal-card">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 id="taskTitle" class="font-bold text-lg">#</h3>
        <p id="taskSubtitle" class="text-sm text-slate-500">請自拍並拍下此編號的標的物（目前不驗證 AI）</p>
      </div>
      <button class="text-slate-500" onclick="toggleTask(false)">✕</button>
    </div>
    <div class="mt-3">
      <div class="rounded-xl border border-dashed border-slate-300 p-3">
        <!-- 修正點：一定要有 name="file" 才會跟著表單送出 -->
        <input id="imageInput" name="file" type="file" accept="image/*;capture=camera" class="block w-full text-sm" />
        <p class="text-xs text-slate-500 mt-1">手機會直接開啟相機；請確保本人入鏡。</p>
      </div>
      <div id="previewWrap" class="mt-3 hidden">
        <img id="previewImg" class="max-h-64 max-w-full object-contain rounded-xl border border-slate-200" alt="預覽"/>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="checkBtn" class="px-3 py-2 rounded-xl bg-[var(--accent)] text-white disabled:opacity-50" disabled>上傳到 Google Drive</button>
        <button class="px-3 py-2 rounded-xl bg-white border border-slate-200" onclick="toggleTask(false)">稍後再試</button>
      </div>
      <div id="resultBox" class="mt-3 hidden">
        <div id="resultText" class="text-sm"></div>
      </div>
      <div id="fallbackBox" class="mt-3 hidden">
        <button id="openWebAppBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200">改用內建上傳頁</button>
      </div>
    </div>
  </div>
</div>

<!-- 隱藏：跨網域免擋表單（新分頁送出） -->
<form id="gasForm"
      action="https://script.google.com/macros/s/AKfycbyeOpL1BM0K5gMqpOswDBqkoKQO8UyRO2btVLNtKkVGb3Fyh-E4bjSxcZVx12sni1r2/exec"
      method="POST" enctype="multipart/form-data" target="_blank" style="display:none"></form>

<script>
/* ======= 你的 Web App URL（正式部署 /exec） ======= */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyeOpL1BM0K5gMqpOswDBqkoKQO8UyRO2btVLNtKkVGb3Fyh-E4bjSxcZVx12sni1r2/exec';
/* ========================================= */

const POINTS = Array.from({length:25}, (_,i)=>({ id:i+1, label:`P${i+1}` }));
let currentPoint = null;
const STORAGE_KEY = "tku_orienteering_progress_v1";
const SID_KEY = "tku_orienteering_sid";

/* 初始化 */
document.addEventListener("DOMContentLoaded", () => {
  renderPOIList(); renderBadges(); updateProgressUI(); bindUI(); loadSID();
  setTimeout(()=>toggleHow(true), 400);
});

function bindUI(){
  document.getElementById("startBtn").addEventListener("click", () => {
    window.scrollTo({ top: document.getElementById("poiList").offsetTop - 16, behavior:"smooth" });
  });
  document.getElementById("badgesBtn").addEventListener("click", () => {
    window.scrollTo({ top: document.getElementById("badgeGrid").offsetTop - 16, behavior:"smooth" });
  });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if(confirm("確定要清除本機進度？")) {
      localStorage.removeItem(STORAGE_KEY);
      renderPOIList(); renderBadges(); updateProgressUI();
    }
  });
  document.getElementById("howBtn").addEventListener("click", () => toggleHow(true));
  document.getElementById("idBtn").addEventListener("click", promptSID);
  document.getElementById("imageInput").addEventListener("change", handleFileChange);
  document.getElementById("checkBtn").addEventListener("click", runUploadOnly);
  document.getElementById("openWebAppBtn").addEventListener("click", openWebAppUploader);
}

function loadSID(){
  const sid = localStorage.getItem(SID_KEY) || "";
  document.getElementById("sidVal").textContent = sid || "（未設定）";
  if(!sid) setTimeout(promptSID, 500);
}
function promptSID(){
  const old = localStorage.getItem(SID_KEY) || "";
  const v = prompt("請輸入你的學號（或識別 ID）：", old);
  if (v !== null) {
    localStorage.setItem(SID_KEY, v.trim());
    document.getElementById("sidVal").textContent = v.trim() || "（未設定）";
  }
}

function toggleHow(show){ document.getElementById("howModal").style.display = show ? "flex" : "none"; }
function toggleTask(show){
  const mask = document.getElementById("taskModal");
  mask.style.display = show ? "flex" : "none";
  if(!show){
    document.getElementById("imageInput").value = "";
    document.getElementById("previewWrap").classList.add("hidden");
    document.getElementById("resultBox").classList.add("hidden");
    document.getElementById("fallbackBox").classList.add("hidden");
    document.getElementById("checkBtn").disabled = true;
    currentPoint = null;
  }
}

/* 5×5 關卡 */
function renderPOIList(){
  const box = document.getElementById("poiList");
  box.innerHTML = "";
  const doneSet = getProgressSet();
  POINTS.forEach(p=>{
    const btn = document.createElement("button");
    btn.className = "pill" + (doneSet.has(p.id) ? " done" : "");
    btn.textContent = `#${p.id}`;
    btn.addEventListener("click", ()=>openTask(p));
    box.appendChild(btn);
  });
}

/* 徽章牆 */
function renderBadges(){
  const grid = document.getElementById("badgeGrid");
  grid.innerHTML = "";
  const doneSet = getProgressSet();
  POINTS.forEach(p=>{
    const card = document.createElement("div");
    card.className = "badge " + (doneSet.has(p.id) ? "done" : "");
    card.innerHTML = `
      <div class="font-bold">#${p.id}</div>
      <div class="mt-2">
        ${doneSet.has(p.id)?'<span class="text-green-600 text-sm">✅ 已獲得</span>':'<span class="text-slate-400 text-sm">🔒 未解鎖</span>'}
      </div>`;
    grid.appendChild(card);
  });
}

/* 進度 */
function getProgressSet(){ try{ return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")); } catch{ return new Set(); } }
function setProgressSet(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(s))); }
function addProgress(id){
  const s = getProgressSet(); s.add(id); setProgressSet(s);
  renderPOIList(); renderBadges(); updateProgressUI();
}
function updateProgressUI(){
  const count = getProgressSet().size;
  const percent = Math.round((count / POINTS.length) * 100);
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressText").textContent = `已完成 ${count} / ${POINTS.length}`;
}

/* 任務流程 */
function openTask(p){
  currentPoint = p;
  document.getElementById("taskTitle").textContent = `#${p.id}`;
  document.getElementById("taskSubtitle").textContent = `請自拍並拍下此編號的標的物（目前不驗證 AI）`;
  toggleTask(true);
}
function handleFileChange(e){
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  document.getElementById("previewImg").src = url;
  document.getElementById("previewWrap").classList.remove("hidden");
  document.getElementById("resultBox").classList.add("hidden");
  document.getElementById("fallbackBox").classList.add("hidden");
  document.getElementById("checkBtn").disabled = false;
}

/* 預開新視窗 + 隱藏表單提交（完全繞過 CORS 與彈窗阻擋） */
async function runUploadOnly(){
  const info = document.getElementById("resultText");
  const box  = document.getElementById("resultBox");
  const fb   = document.getElementById("fallbackBox");
  box.classList.remove("hidden"); fb.classList.add("hidden");

  const sid = localStorage.getItem(SID_KEY) || "";
  if(!sid){ alert("請先設定學號"); return promptSID(); }

  const fileEl = document.getElementById("imageInput");
  const file = fileEl.files[0];
  if(!file){ info.textContent = "請先選擇照片"; return; }
  if(file.size > 20*1024*1024){ info.textContent = "檔案過大（>20MB）"; return; }

  // 後備：讀成 dataURL（後端同時支援 multipart 與 base64）
  const dataURL = await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  // 以使用者手勢預開一個視窗，避免被當作彈出視窗阻擋
  const winName = 'tku_uploader';
  const popup = window.open('about:blank', winName);
  if (!popup) {
    info.innerHTML = "⚠️ 瀏覽器阻擋了新分頁，請允許本頁開啟彈出視窗或按下方「改用內建上傳頁」。";
    fb.classList.remove('hidden');
    return;
  }

  // 填隱藏表單欄位
  const form = document.getElementById("gasForm");
  form.action = WEB_APP_URL;
  form.target = winName;
  form.innerHTML = "";

  const addHidden = (name, val) => {
    const i = document.createElement("input");
    i.type = "hidden"; i.name = name; i.value = val;
    form.appendChild(i);
  };
  addHidden("action", "upload");
  addHidden("sid", sid);
  addHidden("pointId", currentPoint.id);
  addHidden("label", currentPoint.label);
  addHidden("fileBase64", dataURL);
  addHidden("fileType", file.type || "image/jpeg");
  // addHidden("format","json"); // 想看 JSON 回傳時可打開

  // 把 <input type="file" name="file"> 暫移進表單，一起送 multipart
  const placeholder = document.createElement("span");
  fileEl.parentNode.insertBefore(placeholder, fileEl);
  form.appendChild(fileEl);

  // 送出（新分頁顯示 Upload OK / 內建預覽）
  form.submit();
  popup.focus();

  // 把檔案輸入框放回原位
  placeholder.parentNode.insertBefore(fileEl, placeholder);
  placeholder.remove();

  info.innerHTML = "📤 已送出；結果會在新分頁顯示（若沒看到，請允許彈出視窗）。";
  addProgress(currentPoint.id);
}

/* 失敗保險：直接開 /exec 內建上傳頁 */
function openWebAppUploader(){ window.open(WEB_APP_URL, '_blank'); }
</script>
</body>
</html>
