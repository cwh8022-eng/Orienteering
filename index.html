<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ·¡æ±Ÿå¤§å­¸å®šå‘é‹å‹•é—–é—œæŒ‘æˆ°ï½œéš±è— iframe ä¸Šå‚³</title>
<style>
  :root { --accent:#f97316; --ok:#22c55e; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --edge:#e5e7eb; --bg:#fff7ed; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
  .wrap{max-width:1080px;margin:0 auto;padding:24px}
  .row{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:16px}
  .title{font-weight:800;font-size:22px;margin:0 0 4px}
  .muted{color:var(--muted);font-size:13px}
  .btn{cursor:pointer;border-radius:12px;border:1px solid var(--edge);background:#fff;padding:8px 12px}
  .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .bar{height:10px;background:#f1f5f9;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:var(--accent);width:0%}
  .grid5{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
  .pill{height:72px;border-radius:14px;background:var(--accent);color:#fff;font-weight:800;font-size:18px;display:flex;align-items:center;justify-content:center;border:0}
  .pill.done{background:var(--ok)}
  .badge{border:1px dashed var(--edge);border-radius:12px;padding:10px;text-align:center}
  .badge.done{border-style:solid;background:#f0fdf4}
  /* modal */
  .mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(560px,92vw);background:#fff;border-radius:16px;padding:16px;box-shadow:0 24px 64px rgba(0,0,0,.3)}
  .modal h3{margin:0 0 4px}
  .hint{font-size:12px;color:var(--muted)}
  .img-preview{max-height:260px;max-width:100%;object-fit:contain;border:1px solid var(--edge);border-radius:12px}
  /* éš±è— iframeï¼Œå°ˆé–€æ¥ Apps Script å›å‚³ */
  #upload_iframe{position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;border:0}
</style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div style="width:48px;height:48px;border-radius:12px;background:var(--accent);color:#fff;display:grid;place-items:center;font-weight:800">TKU</div>
      <div>
        <h1 style="margin:0;font-weight:800">æ·¡æ±Ÿå¤§å­¸å®šå‘é‹å‹•é—–é—œæŒ‘æˆ°</h1>
        <div class="muted">ä¸ä¸Šæ–°åˆ†é ã€ä¸å½ˆè¦–çª—ï¼šä»¥éš±è— iframe ä¸Šå‚³ä¸¦æ¥æ”¶çµæœã€‚</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="howBtn" class="btn">è¦å‰‡èªªæ˜</button>
        <button id="idBtn"  class="btn">è¨­å®šå­¸è™Ÿ</button>
      </div>
    </header>

    <section class="row">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="title">æˆ‘çš„é—–é—œé€²åº¦</div>
          <button id="resetBtn" class="btn">æ¸…é™¤é€²åº¦</button>
        </div>
        <div class="bar"><i id="progressBar"></i></div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div id="progressText" class="muted">å·²å®Œæˆ 0 / 25</div>
          <div class="muted">å­¸è™Ÿï¼š<span id="sidVal">ï¼ˆæœªè¨­å®šï¼‰</span></div>
        </div>
      </div>

      <div class="card">
        <div class="title">å¿«é€Ÿå‹•ä½œ</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="startBtn" class="btn btn-primary">é–‹å§‹æŒ‘æˆ°</button>
          <button id="badgesBtn" class="btn">æˆ‘çš„å¾½ç« </button>
        </div>
        <p class="muted" style="margin-top:8px">è‹¥æ²’æœ‰åæ‡‰ï¼šè«‹ç¢ºèªä½ ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ /execï¼Œä¸” Apps Script å·²ã€Œéƒ¨ç½²ã€ã€‚</p>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="title">æ ¡åœ’åœ°åœ–ï¼ˆåƒè€ƒï¼‰</div>
      <img src="assets/tku_map.jpg" alt="Tamkang University Orienteering Map"
           style="width:100%;height:auto;border-radius:12px;border:1px solid var(--edge)"
           onerror="this.nextElementSibling.style.display='block'">
      <div class="muted" style="display:none;margin-top:6px">æ‰¾ä¸åˆ°åœ°åœ–ï¼šassets/tku_map.jpg</div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="title">æ‹ç…§ç›®æ¨™ä¸€è¦½ï¼ˆ#1â€“#25ï¼‰</div>
      <img src="assets/tku_targets.jpg" alt="targets"
           style="width:100%;height:auto;border-radius:12px;border:1px solid var(--edge)"
           onerror="this.nextElementSibling.style.display='block'">
      <div class="muted" style="display:none;margin-top:6px">æ‰¾ä¸åˆ°æ‹¼åœ–ï¼šassets/tku_targets.jpg</div>
      <p class="muted" style="margin-top:6px">åªé¡¯ç¤ºç·¨è™Ÿï¼Œä¸æä¾›ä¸­æ–‡åç¨±ã€‚</p>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="title">é—œå¡åˆ—è¡¨ï¼ˆé»æ“Šç·¨è™Ÿä¸Šå‚³ï¼‰</div>
      <div id="poiList" class="grid5" style="margin-top:8px"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div class="title" style="margin:0">å¾½ç« æ”¶é›†</div>
        <div class="muted">è’é›† 25 æšå¾½ç« ï¼Œå³å®Œæˆæœ€çµ‚æŒ‘æˆ°ï¼</div>
      </div>
      <div id="badgeGrid" class="grid5" style="grid-template-columns:repeat(5,1fr)"></div>
    </section>
  </div>

  <!-- è¦å‰‡ Modal -->
  <div id="howModal" class="mask">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>éŠæˆ²è¦å‰‡</h3>
        <button class="btn" onclick="toggleHow(false)">âœ•</button>
      </div>
      <ol style="margin:8px 0 0 18px">
        <li>åœ¨ä¸‹æ–¹ã€Œé—œå¡åˆ—è¡¨ã€é»é¸ #1~#25 ä»»ä¸€æŒ‰éˆ•ã€‚</li>
        <li>è‡ªæ‹ + æ‹ä¸‹è©²é»æ¨™çš„ç‰©ã€‚</li>
        <li>æŒ‰ã€Œä¸Šå‚³åˆ° Google Driveã€ï¼Œç­‰å¾…ä¸‹æ–¹æç¤ºè®Šç‚ºæˆåŠŸã€‚</li>
      </ol>
      <div style="text-align:right;margin-top:12px">
        <button class="btn btn-primary" onclick="toggleHow(false)">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- ä¸Šå‚³ Modalï¼šå›ºå®šè¡¨å–®ï¼ˆtarget æŒ‡å‘éš±è— iframeï¼‰ -->
  <div id="taskModal" class="mask">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;gap:12px">
        <div>
          <h3 id="taskTitle" style="margin-bottom:4px">#</h3>
          <div id="taskSubtitle" class="muted">è«‹è‡ªæ‹ä¸¦æ‹ä¸‹æ­¤ç·¨è™Ÿçš„æ¨™çš„ç‰©ï¼ˆç›®å‰ä¸åš AI é©—è­‰ï¼‰ã€‚</div>
        </div>
        <button class="btn" onclick="toggleTask(false)">âœ•</button>
      </div>

      <!-- éš±è— iframeï¼šæ¥æ”¶ Apps Script å›å‚³ -->
      <iframe id="upload_iframe" name="upload_iframe"></iframe>

      <form id="uploadForm" method="POST" enctype="multipart/form-data" target="upload_iframe" style="margin-top:12px">
        <div style="border:1px dashed var(--edge);border-radius:12px;padding:12px">
          <!-- é—œéµï¼šä¸€å®šè¦ name="file" -->
          <input id="imageInput" name="file" type="file" accept="image/*;capture=camera" style="width:100%" />
          <div class="hint" style="margin-top:6px">æ‰‹æ©Ÿæœƒç›´æ¥é–‹å•Ÿç›¸æ©Ÿï¼›è«‹ç¢ºä¿æœ¬äººå…¥é¡ã€‚</div>
        </div>

        <div id="previewWrap" style="display:none;margin-top:12px">
          <img id="previewImg" class="img-preview" alt="é è¦½">
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <button id="checkBtn" type="button" class="btn btn-primary" disabled>ä¸Šå‚³åˆ° Google Drive</button>
          <button type="button" class="btn" onclick="toggleTask(false)">ç¨å¾Œå†è©¦</button>
        </div>

        <div id="resultBox" style="display:none;margin-top:10px"><div id="resultText" class="muted"></div></div>

        <!-- éš±è—æ¬„ä½ï¼ˆç”± JS å¡«å…¥ï¼›Base64 ç‚ºå¾Œå‚™ï¼‰ -->
        <input type="hidden" name="action" value="upload">
        <input type="hidden" name="sid" id="hfSid">
        <input type="hidden" name="pointId" id="hfPoint">
        <input type="hidden" name="label" id="hfLabel">
        <input type="hidden" name="fileBase64" id="hfB64">
        <input type="hidden" name="fileType" id="hfType">
      </form>
    </div>
  </div>

<script>
/* === ä½ çš„ Apps Script Web Appï¼ˆ/execï¼‰ === */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyeOpL1BM0K5gMqpOswDBqkoKQO8UyRO2btVLNtKkVGb3Fyh-E4bjSxcZVx12sni1r2/exec';

const POINTS = Array.from({length:25}, (_,i)=>({ id:i+1, label:`P${i+1}` }));
let currentPoint = null;
const STORAGE_KEY = "tku_orienteering_progress_v1";
const SID_KEY = "tku_orienteering_sid";

/* åˆå§‹åŒ– */
document.addEventListener("DOMContentLoaded", () => {
  // è¡¨å–® action æŒ‡å‘ /exec
  document.getElementById('uploadForm').action = WEB_APP_URL;

  renderPOIList(); renderBadges(); updateProgressUI(); bindUI(); loadSID();

  // æ¥æ”¶å¾Œç«¯ postMessageï¼ˆéš±è— iframe é€å›ï¼‰
  window.addEventListener('message', (ev) => {
    const data = ev.data || {};
    if (!data || data.source !== 'tku-uploader') return; // åªæ”¶æˆ‘å€‘å®šç¾©çš„è¨Šæ¯
    const info = document.getElementById('resultText');
    const box  = document.getElementById('resultBox');
    box.style.display = 'block';
    if (data.ok) {
      info.innerHTML = `âœ… ä¸Šå‚³æˆåŠŸï¼<br><a href="${data.url}" target="_blank">åœ¨é›²ç«¯é–‹å•Ÿ</a>`;
      addProgress(Number(data.pointId || currentPoint?.id));
    } else {
      info.textContent = "âš ï¸ ä¸Šå‚³å¤±æ•—ï¼š" + (data.error || 'æœªçŸ¥éŒ¯èª¤');
    }
  }, false);
});

function bindUI(){
  id("startBtn").addEventListener("click", () => scrollToEl("poiList"));
  id("badgesBtn").addEventListener("click", () => scrollToEl("badgeGrid"));
  id("resetBtn").addEventListener("click", () => {
    if(confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿé€²åº¦ï¼Ÿ")) { localStorage.removeItem(STORAGE_KEY); renderPOIList(); renderBadges(); updateProgressUI(); }
  });
  id("howBtn").addEventListener("click", () => toggleHow(true));
  id("idBtn").addEventListener("click", promptSID);
  id("imageInput").addEventListener("change", handleFileChange);
  id("checkBtn").addEventListener("click", runUploadOnly);
}

function loadSID(){
  const sid = localStorage.getItem(SID_KEY) || "";
  id("sidVal").textContent = sid || "ï¼ˆæœªè¨­å®šï¼‰";
  if(!sid) setTimeout(promptSID, 300);
}
function promptSID(){
  const old = localStorage.getItem(SID_KEY) || "";
  const v = prompt("è«‹è¼¸å…¥ä½ çš„å­¸è™Ÿï¼ˆæˆ–è­˜åˆ¥ IDï¼‰ï¼š", old);
  if (v !== null) { localStorage.setItem(SID_KEY, v.trim()); id("sidVal").textContent = v.trim() || "ï¼ˆæœªè¨­å®šï¼‰"; }
}

function toggleHow(show){ id("howModal").style.display = show ? "flex" : "none"; }
function toggleTask(show){
  id("taskModal").style.display = show ? "flex" : "none";
  if(!show){
    id("imageInput").value = "";
    id("previewWrap").style.display = "none";
    id("resultBox").style.display = "none";
    id("checkBtn").disabled = true;
    currentPoint = null;
  }
}

/* 5Ã—5 é—œå¡ */
function renderPOIList(){
  const box = id("poiList"); box.innerHTML = "";
  const doneSet = getProgressSet();
  POINTS.forEach(p=>{
    const btn = document.createElement("button");
    btn.className = "pill" + (doneSet.has(p.id) ? " done" : "");
    btn.textContent = `#${p.id}`;
    btn.addEventListener("click", ()=>openTask(p));
    box.appendChild(btn);
  });
}

/* å¾½ç« ç‰† */
function renderBadges(){
  const grid = id("badgeGrid"); grid.innerHTML = "";
  const doneSet = getProgressSet();
  POINTS.forEach(p=>{
    const card = document.createElement("div");
    card.className = "badge " + (doneSet.has(p.id) ? "done" : "");
    card.innerHTML = `<div style="font-weight:700">#${p.id}</div>
                      <div style="margin-top:6px">${doneSet.has(p.id)?'âœ… å·²ç²å¾—':'ğŸ”’ æœªè§£é–'}</div>`;
    grid.appendChild(card);
  });
}

/* é€²åº¦ */
function getProgressSet(){ try{ return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")); } catch{ return new Set(); } }
function setProgressSet(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(s))); }
function addProgress(id){ const s=getProgressSet(); s.add(id); setProgressSet(s); renderPOIList(); renderBadges(); updateProgressUI(); }
function updateProgressUI(){ const c=getProgressSet().size, p=Math.round(c/POINTS.length*100); id("progressBar").style.width=p+"%"; id("progressText").textContent=`å·²å®Œæˆ ${c} / ${POINTS.length}`; }

/* ä»»å‹™æµç¨‹ */
function openTask(p){ currentPoint=p; id("taskTitle").textContent=`#${p.id}`; id("taskSubtitle").textContent=`è«‹è‡ªæ‹ä¸¦æ‹ä¸‹æ­¤ç·¨è™Ÿçš„æ¨™çš„ç‰©`; toggleTask(true); }
function handleFileChange(e){
  const f = e.target.files[0]; if(!f) return;
  id("previewImg").src = URL.createObjectURL(f);
  id("previewWrap").style.display = "block";
  id("resultBox").style.display = "none";
  id("checkBtn").disabled = false;
}

/* æäº¤åˆ°éš±è— iframeï¼›åŒæ™‚é™„ä¸Š Base64 å¾Œå‚™ï¼ˆå¾Œç«¯äºŒé¸ä¸€ï¼‰ */
async function runUploadOnly(){
  const info = id("resultText"); const box=id("resultBox");
  box.style.display = "block"; info.textContent = "æ­£åœ¨ä¸Šå‚³åˆ° Google Driveâ€¦";

  const sid = localStorage.getItem(SID_KEY) || "";
  if(!sid){ alert("è«‹å…ˆè¨­å®šå­¸è™Ÿ"); return promptSID(); }

  const fileEl = id("imageInput");
  const file = fileEl.files[0];
  if(!file){ info.textContent="è«‹å…ˆé¸æ“‡ç…§ç‰‡"; return; }
  if(file.size > 20*1024*1024){ info.textContent="æª”æ¡ˆéå¤§ï¼ˆ>20MBï¼‰"; return; }

  // ç”¢ç”Ÿ Base64 å¾Œå‚™ï¼ˆApps Script è‹¥æ‹¿ä¸åˆ° multipartï¼Œæœƒæ”¹ç”¨é€™å€‹ï¼‰
  const dataURL = await new Promise((ok,ng)=>{ const r=new FileReader(); r.onload=()=>ok(r.result); r.onerror=ng; r.readAsDataURL(file); });

  // å¡«éš±è—æ¬„ä½
  id('hfSid').value   = sid;
  id('hfPoint').value = currentPoint.id;
  id('hfLabel').value = currentPoint.label;
  id('hfB64').value   = dataURL;
  id('hfType').value  = file.type || 'image/jpeg';

  // é€å‡ºï¼ˆtarget=upload_iframeï¼Œä¸æœƒè·³é ï¼‰
  const form = id('uploadForm');
  form.action = WEB_APP_URL;
  form.submit();
}

/* å°å·¥å…· */
function id(s){ return document.getElementById(s); }
function scrollToEl(elId){ const el = id(elId); if(!el) return; window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 12, behavior:"smooth" }); }
</script>
</body>
</html>
