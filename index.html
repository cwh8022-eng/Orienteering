<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ·¡æ±Ÿå¤§å­¸å®šå‘é‹å‹•é—–é—œæŒ‘æˆ°ï¼ˆéš±è— iframe ä¸Šå‚³ï¼‰</title>
<link rel="stylesheet" href="./styles.css">
<style>
  :root { --accent:#f97316; --ok:#22c55e }
  .pill{width:72px;height:72px;display:flex;align-items:center;justify-content:center;border-radius:.9rem;background:var(--accent);color:#fff;font-weight:800}
  .pill.done{background:var(--ok)}
  .badge{border:1px dashed #e5e7eb;border-radius:.75rem;padding:.6rem;text-align:center;font-size:.85rem}
  .badge.done{border-style:solid;background:#f0fdf4}
  .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal-card{width:min(560px,92vw);background:#fff;border-radius:1rem;padding:1rem;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .muted{color:#64748b;font-size:.85rem}
  /* éš±è— iframe */
  #upload_iframe{position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;border:0}
</style>
</head>
<body class="bg-orange-50/40 text-slate-800">
<header class="max-w-6xl mx-auto px-4 py-6 flex items-center gap-4">
  <div class="w-12 h-12 rounded-2xl bg-[var(--accent)] text-white grid place-items-center font-extrabold">TKU</div>
  <div>
    <h1 class="text-2xl md:text-3xl font-extrabold">æ·¡æ±Ÿå¤§å­¸å®šå‘é‹å‹•é—–é—œæŒ‘æˆ°</h1>
    <p class="text-slate-600">ä¸ä¸Šæ–°åˆ†é ã€ä¸å½ˆè¦–çª—ï¼›ç”¨éš±è— iframe ä¸Šå‚³ä¸¦æ¥æ”¶å›å‚³è¨Šæ¯ã€‚</p>
  </div>
  <div class="ms-auto flex gap-2">
    <button id="howBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200">è¦å‰‡èªªæ˜</button>
    <button id="idBtn"  class="px-3 py-2 rounded-xl bg-white border border-slate-200">è¨­å®šå­¸è™Ÿ</button>
  </div>
</header>

<section class="max-w-6xl mx-auto px-4">
  <div class="grid md:grid-cols-3 gap-4 items-stretch">
    <div class="col-span-2 bg-white rounded-2xl p-4 border border-slate-200">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold">æˆ‘çš„é—–é—œé€²åº¦</h2>
        <button id="resetBtn" class="text-sm text-slate-500 hover:text-red-600">æ¸…é™¤é€²åº¦</button>
      </div>
      <div class="w-full bg-slate-100 rounded-xl h-3">
        <div id="progressBar" class="bg-[var(--accent)] h-3 rounded-xl" style="width:0%"></div>
      </div>
      <p id="progressText" class="text-sm mt-2 text-slate-600">å·²å®Œæˆ 0 / 25</p>
      <p class="text-xs mt-1 text-slate-500">å­¸è™Ÿï¼š<span id="sidVal">ï¼ˆæœªè¨­å®šï¼‰</span></p>
    </div>
    <div class="bg-white rounded-2xl p-4 border border-slate-200">
      <h2 class="font-bold mb-2">å¿«é€Ÿå‹•ä½œ</h2>
      <div class="flex flex-wrap gap-2">
        <button id="startBtn" class="px-3 py-2 rounded-xl bg-[var(--accent)] text-white">é–‹å§‹æŒ‘æˆ°</button>
        <button id="badgesBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200">æˆ‘çš„å¾½ç« </button>
      </div>
      <p class="muted mt-3">è‹¥ç„¡å›æ‡‰ï¼Œè«‹ç¢ºèªä½ å·²ç”¨æœ€æ–°çš„ /execï¼Œä¸”å¾Œç«¯å·²æŒ‰ã€Œéƒ¨ç½²ã€ã€‚</p>
    </div>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6">
  <div class="bg-white rounded-2xl p-3 border border-slate-200">
    <h2 class="font-bold mb-3">æ ¡åœ’åœ°åœ–ï¼ˆåƒè€ƒï¼‰</h2>
    <img src="assets/tku_map.jpg" class="w-full h-auto rounded-xl border border-slate-200" alt="map"
         onerror="this.nextElementSibling.classList.remove('hidden')">
    <div class="hidden mt-2 text-sm text-red-600">æ‰¾ä¸åˆ°åœ°åœ–ï¼šassets/tku_map.jpg</div>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6">
  <div class="bg-white rounded-2xl p-3 border border-slate-200">
    <h2 class="font-bold mb-3">æ‹ç…§ç›®æ¨™ä¸€è¦½ï¼ˆ#1â€“#25ï¼‰</h2>
    <img src="assets/tku_targets.jpg" class="w-full h-auto rounded-xl border border-slate-200" alt="targets"
         onerror="this.nextElementSibling.classList.remove('hidden')">
    <div class="hidden mt-2 text-sm text-red-600">æ‰¾ä¸åˆ°æ‹¼åœ–ï¼šassets/tku_targets.jpg</div>
    <p class="text-xs text-slate-500 mt-2">åªé¡¯ç¤ºç·¨è™Ÿï¼Œä¸æä¾›ä¸­æ–‡æç¤ºã€‚</p>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6">
  <div class="bg-white rounded-2xl p-4 border border-slate-200">
    <h2 class="font-bold mb-3">é—œå¡åˆ—è¡¨ï¼ˆé»æ“Šç·¨è™Ÿä¸Šå‚³ï¼‰</h2>
    <div id="poiList" class="grid grid-cols-5 gap-3"></div>
  </div>
</section>

<section class="max-w-6xl mx-auto px-4 mt-6 mb-20">
  <div class="bg-white rounded-2xl p-4 border border-slate-200">
    <div class="flex items-center gap-3 mb-3">
      <h2 class="font-bold">å¾½ç« æ”¶é›†</h2>
      <span class="text-xs text-slate-500">è’é›† 25 æšå¾½ç« ï¼Œå³å®Œæˆæœ€çµ‚æŒ‘æˆ°ï¼</span>
    </div>
    <div id="badgeGrid" class="grid grid-cols-5 sm:grid-cols-6 lg:grid-cols-8 gap-3"></div>
  </div>
</section>

<!-- è¦å‰‡ Modal -->
<div id="howModal" class="modal-mask">
  <div class="modal-card">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-bold text-lg">éŠæˆ²è¦å‰‡</h3>
      <button class="text-slate-500" onclick="toggleHow(false)">âœ•</button>
    </div>
    <ol class="list-decimal ps-5 space-y-1 text-slate-700">
      <li>åœ¨é—œå¡åˆ—è¡¨é»é¸ç·¨è™Ÿï¼ˆ#1~#25ï¼‰ã€‚</li>
      <li>è‡ªæ‹ä¸¦æ‹ä¸‹è©²ç·¨è™Ÿçš„æ¨™çš„ç‰©ã€‚</li>
      <li>æŒ‰ã€Œä¸Šå‚³åˆ° Google Driveã€ï¼Œä¸è·³é ï¼›ç­‰ä¸Šæ–¹æç¤ºè®Šæˆç¶ è‰²æˆåŠŸã€‚</li>
    </ol>
    <div class="mt-4 text-right"><button class="px-3 py-2 rounded-xl bg-[var(--accent)] text-white" onclick="toggleHow(false)">æˆ‘çŸ¥é“äº†</button></div>
  </div>
</div>

<!-- ä¸Šå‚³ Modalï¼ˆå›ºå®šè¡¨å–®ï¼Œtarget æŒ‡å‘éš±è— iframeï¼‰ -->
<div id="taskModal" class="modal-mask">
  <div class="modal-card">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 id="taskTitle" class="font-bold text-lg">#</h3>
        <p id="taskSubtitle" class="text-sm text-slate-500">è«‹è‡ªæ‹ä¸¦æ‹ä¸‹æ­¤ç·¨è™Ÿçš„æ¨™çš„ç‰©ï¼ˆç›®å‰ä¸é©—è­‰ AIï¼‰</p>
      </div>
      <button class="text-slate-500" onclick="toggleTask(false)">âœ•</button>
    </div>

    <!-- éš±è— iframeï¼šæ¥æ”¶å›å‚³ï¼ˆä¸è·³é ï¼‰ -->
    <iframe id="upload_iframe" name="upload_iframe"></iframe>

    <form id="uploadForm" method="POST" enctype="multipart/form-data" target="upload_iframe">
      <div class="mt-3">
        <div class="rounded-xl border border-dashed border-slate-300 p-3">
          <!-- é—œéµï¼šä¸€å®šè¦ name="file" -->
          <input id="imageInput" name="file" type="file" accept="image/*;capture=camera" class="block w-full text-sm" />
          <p class="text-xs text-slate-500 mt-1">æ‰‹æ©Ÿæœƒç›´æ¥é–‹å•Ÿç›¸æ©Ÿï¼›è«‹ç¢ºä¿æœ¬äººå…¥é¡ã€‚</p>
        </div>
        <div id="previewWrap" class="mt-3 hidden">
          <img id="previewImg" class="max-h-64 max-w-full object-contain rounded-xl border border-slate-200" alt="é è¦½">
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="checkBtn" type="button" class="px-3 py-2 rounded-xl bg-[var(--accent)] text-white disabled:opacity-50" disabled>
            ä¸Šå‚³åˆ° Google Drive
          </button>
          <button type="button" class="px-3 py-2 rounded-xl bg-white border border-slate-200" onclick="toggleTask(false)">ç¨å¾Œå†è©¦</button>
        </div>
        <div id="resultBox" class="mt-3 hidden"><div id="resultText" class="text-sm"></div></div>
      </div>

      <!-- éš±è—æ¬„ä½ï¼ˆç”± JS å¡«å…¥ï¼›Base64 ç‚ºå¾Œå‚™ï¼‰ -->
      <input type="hidden" name="action" value="upload">
      <input type="hidden" name="sid" id="hfSid">
      <input type="hidden" name="pointId" id="hfPoint">
      <input type="hidden" name="label" id="hfLabel">
      <input type="hidden" name="fileBase64" id="hfB64">
      <input type="hidden" name="fileType" id="hfType">
    </form>
  </div>
</div>

<script>
/* === ä½ çš„ Apps Script Web Appï¼ˆ/execï¼‰ === */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyeOpL1BM0K5gMqpOswDBqkoKQO8UyRO2btVLNtKkVGb3Fyh-E4bjSxcZVx12sni1r2/exec';

const POINTS = Array.from({length:25}, (_,i)=>({ id:i+1, label:`P${i+1}` }));
let currentPoint = null;
const STORAGE_KEY = "tku_orienteering_progress_v1";
const SID_KEY = "tku_orienteering_sid";

/* åˆå§‹åŒ– */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('uploadForm').action = WEB_APP_URL;
  renderPOIList(); renderBadges(); updateProgressUI(); bindUI(); loadSID();

  // æ¥æ”¶å¾Œç«¯ postMessageï¼ˆä¾†è‡ªéš±è— iframeï¼‰
  window.addEventListener('message', (ev) => {
    const data = ev.data || {};
    if (data && data.source === 'tku-uploader') {
      const info = document.getElementById('resultText');
      const box  = document.getElementById('resultBox');
      box.classList.remove('hidden');
      if (data.ok) {
        info.innerHTML = `âœ… ä¸Šå‚³æˆåŠŸï¼<br><a class="text-blue-600 underline" target="_blank" href="${data.url}">åœ¨é›²ç«¯é–‹å•Ÿ</a>`;
        addProgress(Number(data.pointId || currentPoint?.id));
      } else {
        info.innerHTML = `âš ï¸ ä¸Šå‚³å¤±æ•—ï¼š${data.error || 'æœªçŸ¥éŒ¯èª¤'}`;
      }
    }
  }, false);
});

function bindUI(){
  document.getElementById("startBtn").addEventListener("click", () => {
    window.scrollTo({ top: document.getElementById("poiList").offsetTop - 16, behavior:"smooth" });
  });
  document.getElementById("badgesBtn").addEventListener("click", () => {
    window.scrollTo({ top: document.getElementById("badgeGrid").offsetTop - 16, behavior:"smooth" });
  });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if(confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿé€²åº¦ï¼Ÿ")) { localStorage.removeItem(STORAGE_KEY); renderPOIList(); renderBadges(); updateProgressUI(); }
  });
  document.getElementById("howBtn").addEventListener("click", () => toggleHow(true));
  document.getElementById("idBtn").addEventListener("click", promptSID);
  document.getElementById("imageInput").addEventListener("change", handleFileChange);
  document.getElementById("checkBtn").addEventListener("click", runUploadOnly);
}

function loadSID(){
  const sid = localStorage.getItem(SID_KEY) || "";
  document.getElementById("sidVal").textContent = sid || "ï¼ˆæœªè¨­å®šï¼‰";
  if(!sid) setTimeout(promptSID, 300);
}
function promptSID(){
  const old = localStorage.getItem(SID_KEY) || "";
  const v = prompt("è«‹è¼¸å…¥ä½ çš„å­¸è™Ÿï¼ˆæˆ–è­˜åˆ¥ IDï¼‰ï¼š", old);
  if (v !== null) { localStorage.setItem(SID_KEY, v.trim()); document.getElementById("sidVal").textContent = v.trim() || "ï¼ˆæœªè¨­å®šï¼‰"; }
}

function toggleHow(show){ document.getElementById("howModal").style.display = show ? "flex" : "none"; }
function toggleTask(show){
  const mask = document.getElementById("taskModal");
  mask.style.display = show ? "flex" : "none";
  if(!show){
    document.getElementById("imageInput").value = "";
    document.getElementById("previewWrap").classList.add("hidden");
    document.getElementById("resultBox").classList.add("hidden");
    document.getElementById("checkBtn").disabled = true;
    currentPoint = null;
  }
}

/* 5Ã—5 é—œå¡ */
function renderPOIList(){
  const box = document.getElementById("poiList");
  box.innerHTML = "";
  const doneSet = getProgressSet();
  POINTS.forEach(p=>{
    const btn = document.createElement("button");
    btn.className = "pill" + (doneSet.has(p.id) ? " done" : "");
    btn.textContent = `#${p.id}`;
    btn.addEventListener("click", ()=>openTask(p));
    box.appendChild(btn);
  });
}

/* å¾½ç« ç‰† */
function renderBadges(){
  const grid = document.getElementById("badgeGrid");
  grid.innerHTML = "";
  const doneSet = getProgressSet();
  POINTS.forEach(p=>{
    const card = document.createElement("div");
    card.className = "badge " + (doneSet.has(p.id) ? "done" : "");
    card.innerHTML = `<div class="font-bold">#${p.id}</div>
                      <div class="mt-2">${doneSet.has(p.id)?'âœ… å·²ç²å¾—':'ğŸ”’ æœªè§£é–'}</div>`;
    grid.appendChild(card);
  });
}

/* é€²åº¦ */
function getProgressSet(){ try{ return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")); } catch{ return new Set(); } }
function setProgressSet(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(s))); }
function addProgress(id){ const s = getProgressSet(); s.add(id); setProgressSet(s); renderPOIList(); renderBadges(); updateProgressUI(); }
function updateProgressUI(){ const c=getProgressSet().size; const p=Math.round(c/POINTS.length*100);
  document.getElementById("progressBar").style.width = p + "%";
  document.getElementById("progressText").textContent = `å·²å®Œæˆ ${c} / ${POINTS.length}`;
}

/* ä»»å‹™æµç¨‹ */
function openTask(p){ currentPoint=p; document.getElementById("taskTitle").textContent=`#${p.id}`; document.getElementById("taskSubtitle").textContent=`è«‹è‡ªæ‹ä¸¦æ‹ä¸‹æ­¤ç·¨è™Ÿçš„æ¨™çš„ç‰©`; toggleTask(true); }
function handleFileChange(e){
  const f = e.target.files[0]; if(!f) return;
  document.getElementById("previewImg").src = URL.createObjectURL(f);
  document.getElementById("previewWrap").classList.remove("hidden");
  document.getElementById("resultBox").classList.add("hidden");
  document.getElementById("checkBtn").disabled=false;
}

/* æäº¤åˆ°éš±è— iframeï¼›åŒæ™‚é™„ä¸Š Base64 å¾Œå‚™ï¼ˆå¾Œç«¯äºŒé¸ä¸€ï¼‰ */
async function runUploadOnly(){
  const info = document.getElementById("resultText"); const box=document.getElementById("resultBox");
  box.classList.remove("hidden"); info.textContent="æ­£åœ¨ä¸Šå‚³åˆ° Google Driveâ€¦";

  const sid = localStorage.getItem(SID_KEY) || "";
  if(!sid){ alert("è«‹å…ˆè¨­å®šå­¸è™Ÿ"); return promptSID(); }

  const fileEl = document.getElementById("imageInput");
  const file = fileEl.files[0];
  if(!file){ info.textContent="è«‹å…ˆé¸æ“‡ç…§ç‰‡"; return; }
  if(file.size > 20*1024*1024){ info.textContent="æª”æ¡ˆéå¤§ï¼ˆ>20MBï¼‰"; return; }

  // ç”¢ç”Ÿ Base64 å¾Œå‚™
  const dataURL = await new Promise((ok,ng)=>{ const r=new FileReader(); r.onload=()=>ok(r.result); r.onerror=ng; r.readAsDataURL(file); });

  // å¡«éš±è—æ¬„ä½
  document.getElementById('hfSid').value   = sid;
  document.getElementById('hfPoint').value = currentPoint.id;
  document.getElementById('hfLabel').value = currentPoint.label;
  document.getElementById('hfB64').value   = dataURL;
  document.getElementById('hfType').value  = file.type || 'image/jpeg';

  // é€å‡ºï¼ˆtarget=upload_iframeï¼Œä¸æœƒè·³é ï¼‰
  const form = document.getElementById('uploadForm');
  form.action = WEB_APP_URL;
  form.submit();
}
</script>
</body>
</html>
