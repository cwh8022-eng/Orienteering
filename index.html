<script>
async function runUploadOnly(){
  const info = document.getElementById("resultText");
  const box  = document.getElementById("resultBox");
  const fb   = document.getElementById("fallbackBox");
  box.classList.remove("hidden"); fb.classList.add("hidden");

  const sid = localStorage.getItem("tku_orienteering_sid") || "";
  if(!sid){ alert("請先設定學號"); return promptSID(); }

  const fileEl = document.getElementById("imageInput");
  const file = fileEl.files[0];
  if(!file){ info.textContent = "請先選擇照片"; return; }
  if(file.size > 20*1024*1024){ info.textContent = "檔案過大（>20MB）"; return; }

  // 讀成 dataURL，送做後備欄位（GAS 兩種都支援）
  const dataURL = await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  // 先以「使用者手勢」預開一個視窗，避免被當作彈出視窗擋掉
  const winName = 'tku_uploader';
  const popup = window.open('about:blank', winName);
  if (!popup) {
    info.innerHTML = "⚠️ 瀏覽器阻擋了新分頁，請允許本頁開啟彈出視窗或按下方「改用內建上傳頁」。";
    fb.classList.remove('hidden');
    return;
  }

  // 填隱藏表單欄位
  const form = document.getElementById("gasForm");
  form.action = WEB_APP_URL;
  form.target = winName;     // 指向剛剛預開的視窗
  form.innerHTML = "";

  const addHidden = (name, val) => {
    const i = document.createElement("input");
    i.type = "hidden"; i.name = name; i.value = val;
    form.appendChild(i);
  };
  addHidden("action", "upload");              // 後端辨識為上傳
  addHidden("sid", sid);
  addHidden("pointId", currentPoint.id);
  addHidden("label", currentPoint.label);
  addHidden("fileBase64", dataURL);
  addHidden("fileType", file.type || "image/jpeg");
  // addHidden("format","json"); // 若想在新分頁直接看到 JSON 回傳，可打開

  // 把檔案輸入框暫時移進表單，一起送 multipart
  const placeholder = document.createElement("span");
  fileEl.parentNode.insertBefore(placeholder, fileEl);
  form.appendChild(fileEl);

  // 送出（新分頁會顯示 Upload OK / 內建預覽）
  form.submit();
  popup.focus();

  // 把檔案輸入框放回原位
  placeholder.parentNode.insertBefore(fileEl, placeholder);
  placeholder.remove();

  info.innerHTML = "📤 已送出；結果會在新分頁顯示（若沒看到，請允許彈出視窗）。";
  addProgress(currentPoint.id);
}
</script>
