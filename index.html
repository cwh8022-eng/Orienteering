<script>
async function runUploadOnly(){
  const info = document.getElementById("resultText");
  const box  = document.getElementById("resultBox");
  const fb   = document.getElementById("fallbackBox");
  box.classList.remove("hidden"); fb.classList.add("hidden");

  const sid = localStorage.getItem("tku_orienteering_sid") || "";
  if(!sid){ alert("è«‹å…ˆè¨­å®šå­¸è™Ÿ"); return promptSID(); }

  const fileEl = document.getElementById("imageInput");
  const file = fileEl.files[0];
  if(!file){ info.textContent = "è«‹å…ˆé¸æ“‡ç…§ç‰‡"; return; }
  if(file.size > 20*1024*1024){ info.textContent = "æª”æ¡ˆéå¤§ï¼ˆ>20MBï¼‰"; return; }

  // è®€æˆ dataURLï¼Œé€åšå¾Œå‚™æ¬„ä½ï¼ˆGAS å…©ç¨®éƒ½æ”¯æ´ï¼‰
  const dataURL = await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  // å…ˆä»¥ã€Œä½¿ç”¨è€…æ‰‹å‹¢ã€é é–‹ä¸€å€‹è¦–çª—ï¼Œé¿å…è¢«ç•¶ä½œå½ˆå‡ºè¦–çª—æ“‹æ‰
  const winName = 'tku_uploader';
  const popup = window.open('about:blank', winName);
  if (!popup) {
    info.innerHTML = "âš ï¸ ç€è¦½å™¨é˜»æ“‹äº†æ–°åˆ†é ï¼Œè«‹å…è¨±æœ¬é é–‹å•Ÿå½ˆå‡ºè¦–çª—æˆ–æŒ‰ä¸‹æ–¹ã€Œæ”¹ç”¨å…§å»ºä¸Šå‚³é ã€ã€‚";
    fb.classList.remove('hidden');
    return;
  }

  // å¡«éš±è—è¡¨å–®æ¬„ä½
  const form = document.getElementById("gasForm");
  form.action = WEB_APP_URL;
  form.target = winName;     // æŒ‡å‘å‰›å‰›é é–‹çš„è¦–çª—
  form.innerHTML = "";

  const addHidden = (name, val) => {
    const i = document.createElement("input");
    i.type = "hidden"; i.name = name; i.value = val;
    form.appendChild(i);
  };
  addHidden("action", "upload");              // å¾Œç«¯è¾¨è­˜ç‚ºä¸Šå‚³
  addHidden("sid", sid);
  addHidden("pointId", currentPoint.id);
  addHidden("label", currentPoint.label);
  addHidden("fileBase64", dataURL);
  addHidden("fileType", file.type || "image/jpeg");
  // addHidden("format","json"); // è‹¥æƒ³åœ¨æ–°åˆ†é ç›´æ¥çœ‹åˆ° JSON å›å‚³ï¼Œå¯æ‰“é–‹

  // æŠŠæª”æ¡ˆè¼¸å…¥æ¡†æš«æ™‚ç§»é€²è¡¨å–®ï¼Œä¸€èµ·é€ multipart
  const placeholder = document.createElement("span");
  fileEl.parentNode.insertBefore(placeholder, fileEl);
  form.appendChild(fileEl);

  // é€å‡ºï¼ˆæ–°åˆ†é æœƒé¡¯ç¤º Upload OK / å…§å»ºé è¦½ï¼‰
  form.submit();
  popup.focus();

  // æŠŠæª”æ¡ˆè¼¸å…¥æ¡†æ”¾å›åŸä½
  placeholder.parentNode.insertBefore(fileEl, placeholder);
  placeholder.remove();

  info.innerHTML = "ğŸ“¤ å·²é€å‡ºï¼›çµæœæœƒåœ¨æ–°åˆ†é é¡¯ç¤ºï¼ˆè‹¥æ²’çœ‹åˆ°ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—ï¼‰ã€‚";
  addProgress(currentPoint.id);
}
</script>
